{% extends "base.html" %}
{% load url from future %}

{% block extra_head %}
<link rel="stylesheet" href="{{ STATIC_URL }}jquery-ui-1.9.2.custom/css/overcast/jquery-ui-1.9.2.custom.css"
      xmlns="http://www.w3.org/1999/html"/>
{% endblock %}

{% block toes %}
<script src="{{ STATIC_URL }}jquery-ui-1.9.2.custom/js/jquery-ui-1.9.2.custom.js"></script>

<script>
$(document).ready(function()
{
    var error_dialog = $("#error_dialog").dialog(
    {
        autoOpen: false,
        title: 'Error',
        modal: true,
        position: 'center'
    });

    $('.add_parameter_form').submit(function ()
    {
        $('#save_parameter_button').attr('disabled', true);
        var form = $(this);
        $.ajax(
        {
            data: $(this).serialize(),
            type: $(this).attr('method'),
            url: $(this).attr('action'),
            success: function (xhr, status, error) {
                window.location.reload(true);
            },
            error: function(xhr, status, error) {
                $('#error_message').empty();
                var obj = JSON.parse(xhr.responseText);

                $.each(obj['__all__'], function (i, value)
                {
                    $('#error_dialog').append('<p class=\"text-warning\">' + value + '</p>');
                });

                error_dialog.dialog({ close: function() { $(this).empty(); } });
                error_dialog.dialog('open');

                $('#save_parameter_button').attr('disabled', false);
            }
        });
        return false;
    });

    $(".add_parameter").click(function()
    {
        $(this).siblings('table').children('tbody').find('tr.add_parameter_row').show();
        $(this).siblings('div.hide').show();
        $(this).hide();
    });

    $(".cancel").click(function()
    {
        $(this).closest('div.hide').siblings('table').children('tbody').find('tr.add_parameter_row').hide();
        $(this).closest('div.hide').hide();
        $(this).closest('div.hide').siblings('a.add_parameter').show();
    });

    return false;
});

</script>
{% endblock %}

{% block body %}
<div id="error_dialog"></div>


  <div class="container">
    <div class="row lead">
      <div class="span4">
        <a href="{% url 'view_project' project.id %}">{{ project.project_name }}</a>
      </div>
      <div class="pull-right">Panels <span class="badge badge-inverse align-top">{{ panels.count }}</span></div>
    </div>
    <table class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>Panel</th>
          <th>Site</th>
          <th>Parameters</th>
        </tr>
      </thead>
      <tbody>
        {% for panel in panels %}
        <tr>
          <td>
            {{ panel.panel_name }}
            <span class="pull-right">
              <a rel="tooltip" href="{% url 'edit_panel' panel.id %}" data-original-title="Edit Panel" data-placement="left">
                  <i style="opacity: 0.4" class="icon-th-list align-middle"></i>
              </a>
            </span>
          </td>
          <td>{{ panel.site.site_name }}</td>
          <td width="75%">
            <table class="table table-bordered table-hover">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Value Type</th>
                  <th>FCS Text <a rel="tooltip" class="pull-right label label-inverse" data-original-title="Exact text from the FCS $PnN field" data-placement="left">?</a></th>
                </tr>
              </thead>
              <tbody>
                {% for ppm in panel.panelparametermap_set.all %}
                <tr>
                  <td width="33%">
                    {{ ppm.parameter.parameter_short_name }}
                    <span class="pull-right">
                      <a class="remove_parameter" rel="tooltip" href="{% url 'remove_panel_parameter' ppm.id %}" data-original-title="Remove Parameter" data-placement="right">
                        <i style="opacity: 0.4" class="icon-remove align-middle"></i>
                      </a>
                    </span>
                  </td>
                  <td>
                      {{ ppm.value_type.value_type_name }}
                  </td>
                  <td>
                      {{ ppm.fcs_text }}
                  </td>
                </tr>
                {% endfor %}
                <tr class="hide add_parameter_row">
                  <td>
                    <form class="add_parameter_form" style="margin: 0px; padding:0px" action="{% url 'project_panels' project.id %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="panel" value="{{ panel.id }}">
                    {{ form.parameter }}
                  </td>
                  <td>
                    {{ form.value_type }}
                  </td>
                  <td>
                    {{ form.fcs_text }}
                  </td>
                </tr>
              </tbody>
            </table>

            {% if panel.panelparametermap_set.all.count == 0 %}
            <p>No parameters have been associated with this panel.</p>
            {% endif %}
            <a class="add_parameter btn btn-success btn-mini" href="#">
              <i class="icon-plus icon-white"></i> Add Parameter
            </a>
            <div class="hide control-group">
              <div class="controls">
                  <button id="save_parameter_button" class="btn btn-small btn-primary" type="submit">Save</button>
                  <a class="cancel btn btn-small btn-warning">Cancel</a>
                  <span style="font-size: 12px">Can't find a parameter? <a href="#">Create one</a></span>
              </div>
            </div>
          </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="pull-right">
      <a class="btn btn-success btn-small" href="{% url 'add_panel' project.id %}">
        <i class="icon-plus icon-white"></i> Add Panel
      </a>
    </div>
  </div>
{% endblock %}